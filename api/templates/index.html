<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kesalahan Livechat ({{ current_sheet if current_sheet else 'Live' }})</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">

    {# --- TAUTAN KE CDN TAILWIND CSS --- #}
    <script src="https://cdn.tailwindcss.com"></script>
    {# --------------------------------- #}

    {# --- VERCEL WEB ANALYTICS & GOOGLE ANALYTICS (TETAP) --- #}
    <script src="/_vercel/insights/script.js" defer></script>
    <script src="/_vercel/speed-insights/script.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KV2KNVBYGD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KV2KNVBYGD');
    </script>
    {# ----------------------------------------------------- #}
    
    <style>
        /* SCROLLBAR STYLES - TETAP PERLU UNTUK CUSTOMISASI DETAIL SCROLLBAR DI WEBKIT */
        .sidebar-custom::-webkit-scrollbar { width: 8px; }
        .sidebar-custom::-webkit-scrollbar-track { background: #1f2937; } /* bg-gray-800 dark */
        .sidebar-custom::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } /* bg-gray-600 */
        .sidebar-custom::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* bg-gray-500 */

        .main-content-custom::-webkit-scrollbar { width: 8px; }
        .main-content-custom::-webkit-scrollbar-track { background: #f9fafb; } /* bg-gray-50 light */
        .main-content-custom::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } /* bg-gray-400 */
        .main-content-custom::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* bg-gray-500 */
        
        /* GAYA UNTUK STICKY COLUMN: DIBUTUHKAN CSS TRADISIONAL UNTUK BEBERAPA PROPERTI STICKY KOMPLEKS */
        .sticky-col-header { 
            position: sticky !important; 
            left: 0 !important; 
            top: 0;
            z-index: 20 !important; /* Lebih tinggi dari th normal (z-10) */
            border-right: 3px solid #6b7280 !important; /* border-r-3 border-gray-500 */
            background-color: #1f2937 !important; /* bg-gray-900 */
        }
        .sticky-col-cell { 
            position: sticky !important; 
            left: 0 !important; 
            z-index: 15 !important; 
            border-right: 3px solid #6b7280 !important; 
        }

        /* GAYA UNTUK LINK DI DETAIL KESALAHAN */
        .table-kesalahan a {
            color: #3b82f6; /* Tailwind blue-500 */
            text-decoration: none; /* Menghilangkan underline default */
            font-weight: 500; /* Menjadi medium */
        }
        .table-kesalahan a:hover {
            color: #2563eb; /* Tailwind blue-600 */
            text-decoration: underline; /* Menambahkan underline saat hover */
        }

        /* GAYA UNTUK HOVER STICKY CELL */
        .staff-table-body tr:nth-child(even) .sticky-col-cell { background-color: #f3f4f6; /* bg-gray-50 */ }
        .staff-table-body tr:nth-child(odd) .sticky-col-cell { background-color: #ffffff; /* bg-white */ }
        .staff-table-body tr:hover .sticky-col-cell { background-color: #c7d2fe !important; color: black !important;}
        .summary-total .sticky-col-cell { background-color: #10b981 !important; /* bg-emerald-500 */ }

    </style>
</head>
<body class="font-sans antialiased text-gray-800 flex bg-gray-50 min-h-screen">
    
    {% if sheet_names %}
    {# SIDEBAR #}
    <div class="sidebar-custom w-64 bg-gray-900 text-white px-5 shadow-lg flex-shrink-0 fixed h-screen top-0 left-0 overflow-y-auto z-50">
    
    {# REVISI FINAL DENGAN PENETRALAN PADDING INDUK YANG LEBIH AKURAT #}
    <h2 class="text-xl font-bold uppercase pb-3 mb-4 border-b border-gray-700 text-emerald-400 flex items-center 
        sticky top-0 z-20 bg-gray-900 -mx-5 px-5 -mt-5 pt-5"> 
        <img src="{{ url_for('static', filename='favicon.png') }}" alt="Livechat Icon" class="w-12 h-12 mr-3">
        Kesalahan Livechat
    </h2>
    
    <div class="sheet-nav space-y-1 py-5">
            <a href="{{ url_for('show_summary') }}"
                class="block p-3 text-sm text-gray-300 rounded-lg transition duration-200 hover:bg-indigo-700 hover:text-white
                {% if current_sheet == 'Summary' %}bg-emerald-600 text-white font-semibold border-l-4 border-emerald-400 pl-[14px] hover:bg-emerald-700{% endif %}">
                <svg class="w-4 h-4 inline-block mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                RINGKASAN TOTAL
            </a>

            {% for name in sheet_names %}
                <a href="{{ url_for('show_data', sheet_name=name) }}"
                    class="block p-3 text-sm text-gray-300 rounded-lg transition duration-200 hover:bg-indigo-700 hover:text-white
                    {% if name == current_sheet and current_sheet != 'Summary' %}bg-emerald-600 text-white font-semibold border-l-4 border-emerald-400 pl-[14px] hover:bg-emerald-700{% endif %}">
                    <svg class="w-4 h-4 inline-block mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    {{ name }}
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# MAIN CONTENT #}
    <div class="main-content-custom ml-64 p-8 flex-grow overflow-y-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Data Kesalahan Livechat: <span class="text-emerald-600">{{ current_sheet if current_sheet else 'Pilih Sheet' }}</span></h1>

        {% if current_sheet == 'Summary' %}
        <div class="flex flex-wrap gap-5 mb-10 items-start">

            {# RINGKASAN SITUS - DIUBAH MENGGUNAKAN BASIS CALC 30% #}
            <div class="table-summary flex-1 min-w-[300px] w-full lg:w-auto lg:basis-[calc(40%-10px)] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

                {# JUDUL DAN TOTAL KESALAHAN SITUS BARU #}
                <div class="flex justify-between items-center px-6 pt-4 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Ringkasan Total Kesalahan per Situs</h2>
                    {% if grand_total %}
                    <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                        GRAND TOTAL: {{ grand_total | format_number }}
                    </div>
                    {% endif %}
                </div>
                {# AKHIR JUDUL DAN TOTAL KESALAHAN SITUS BARU #}

                {# PERUBAHAN DI SINI: MENGUBAH overflow-x-auto menjadi overflow-y-auto (jika hanya ingin scroll vertikal) #}
                <div class="overflow-y-auto max-h-[calc(100vh-200px)]">
                    {# PERUBAHAN DI SINI: MENGHILANGKAN min-w-[600px] #}
                    <table class="data-table w-full text-sm text-left border-collapse"> 
                        <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center w-[5%]">No.</th>
                                <th scope="col" class="px-6 py-3 w-[65%]">Nama Situs</th>
                                <th scope="col" class="px-6 py-3 text-right w-[30%]">Total Kesalahan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary_data %}
                            <tr class="bg-white border-b hover:bg-indigo-200 transition duration-150">
                                <td class="px-6 py-3 text-center font-medium">{{ loop.index }}</td>
                                <td class="px-6 py-3">
                                    <a href="{{ item.url }}" class="text-gray-800 font-medium hover:text-emerald-600 hover:underline">
                                        {{ item.name }}
                                    </a>
                                </td>
                                <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.total | format_number }}</td>
                            </tr>
                            {% endfor %}

                            {% if not summary_data and not grand_total %}
                            <tr>
                                <td colspan="3" class="px-6 py-8 text-center text-gray-500 italic">
                                    Tidak ada data kesalahan yang ditemukan di sheet bulanan.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            {# RINGKASAN STAFF - DIUBAH MENGGUNAKAN BASIS CALC 70% #}
            <div class="table-summary-leader flex-1 min-w-[400px] w-full lg:w-auto lg:basis-[calc(60%-10px)] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

                {# JUDUL DAN TOTAL KESALAHAN STAFF BARU #}
                <div class="flex justify-between items-center px-6 pt-4 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Ringkasan Total Kesalahan per Staff</h2>
                    {% if staff_grand_total %}
                    <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                        GRAND TOTAL: {{ staff_grand_total | format_number }}
                    </div>
                    {% endif %}
                </div>
                {# AKHIR JUDUL DAN TOTAL KESALAHAN STAFF BARU #}

                <div class="overflow-x-auto max-h-[calc(100vh-170px)]">
                    <table class="data-table w-full text-sm text-left border-collapse min-w-[800px]">
                        <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center w-[5%]">NO</th>
                                <th scope="col" class="px-6 py-3 w-[35%]">NAMA</th>
                                <th scope="col" class="px-6 py-3 w-[40%]">SITUS (Total Per Situs)</th>
                                <th scope="col" class="px-6 py-3 text-right w-[20%]">TOTAL KESELURUHAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary_staff_data %}
                                {% for item in summary_staff_data %}
                                <tr class="staff-row border-b hover:bg-indigo-200 transition duration-150 {% if loop.index > 1 %}border-t-2 border-gray-400{% endif %}">
                                    <td class="px-6 py-3 text-center font-medium">{{ item.no }}</td>
                                    <td class="px-6 py-3"><strong class="text-gray-900">{{ item.name }}</strong></td>
                                    <td class="px-6 py-3 text-xs text-gray-600">{{ item.situs_details }}</td>
                                    <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.grand_total_staff | format_number }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">
                                        Tidak ada data ringkasan staff yang ditemukan.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            {# RINGKASAN LEADER (TETAP W-FULL, BERADA DI BARIS BARU) #}
            <div class="table-summary-staff w-full bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

                {# JUDUL DAN TOTAL KESALAHAN LEADER BARU #}
                <div class="flex justify-between items-center px-6 pt-4 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Ringkasan Total Kesalahan per Leader</h2>
                    {% if leader_grand_total %}
                    <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                        GRAND TOTAL: {{ leader_grand_total | format_number }}
                    </div>
                    {% endif %}
                </div>
                {# AKHIR JUDUL DAN TOTAL KESALAHAN LEADER BARU #}

                <div class="overflow-x-auto max-h-[calc(100vh-200px)]">
                    <table class="data-table w-full text-sm text-left border-collapse min-w-[800px]">
                        <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center w-[5%]">NO</th>
                                <th scope="col" class="px-6 py-3 w-[25%]">NAMA LEADER</th>
                                <th scope="col" class="px-6 py-3 w-[50%]">NAMA SITUS (Total Per Situs)</th>
                                <th scope="col" class="px-6 py-3 text-right w-[20%]">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary_leader_data %}
                                {% for item in summary_leader_data %}
                                <tr class="leader-row border-b hover:bg-indigo-200 transition duration-150 {% if loop.index > 1 %}border-t-2 border-gray-400{% endif %}">
                                    <td class="px-6 py-3 text-center font-medium">{{ item.no }}</td>
                                    <td class="px-6 py-3"><strong class="text-gray-900">{{ item.name }}</strong></td>
                                    <td class="px-6 py-3 text-xs text-gray-600">{{ item.situs_details | safe }}</td>
                                    <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.total | format_number }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">
                                        Tidak ada data ringkasan leader yang ditemukan (periksa mapping situs).
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
            {# DETAIL SHEET VIEW (KESALAHAN + STAFF) #}
            <div class="flex flex-wrap gap-5 mb-10 items-start">
            
                {# DETAIL KESALAHAN #}
                {% if kesalahan_headers and kesalahan_data %}
                <div class="table-kesalahan flex-1 min-w-[350px] max-w-[40%] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100 p-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 px-2 pt-2">Detail Kesalahan</h2>
                    <div class="overflow-x-auto max-h-[calc(100vh-120px)]">
                        <table class="data-table w-full text-sm text-left border-collapse">
                            <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                                <tr>
                                    {% for header in kesalahan_headers %}
                                    <th scope="col" class="px-6 py-3 {% if loop.index == 2 %}min-w-[150px]{% endif %}">{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in kesalahan_data %}
                                <tr class="bg-white border-b hover:bg-indigo-200 transition duration-150">
                                    {% for cell in row %}
                                    <td class="px-6 py-3 align-top link-cell">
                                        <div class="cell-content max-w-[250px] break-words">
                                            {{ cell | render_cell | safe }}
                                        </div>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                                {% if current_sheet in SHEET_KHUSUS %}
                                <tr class="summary-total bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition duration-150">
                                    <td colspan="{{ kesalahan_headers|length }}" class="px-6 py-3 text-base">Total: {{ kesalahan_data|length }} baris</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 italic flex-1 min-w-[350px] max-w-[40%] bg-white shadow-xl rounded-lg p-6">Tidak ada data kesalahan untuk sheet ini.</p>
                {% endif %}


                {# DETAIL STAFF #}
                {% if staff_headers and staff_rows %}
                <div class="table-staff flex-1 min-w-[400px] max-w-[58%] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

                    {# JUDUL DAN TOTAL KESALAHAN STAFF BARU (SUDAH DIPINDAHKAN) #}
                    <div class="flex justify-between items-center px-6 pt-4 mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Data Staff</h2>
                        {% if total_kesalahan_staff is not none %}
                        <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                            TOTAL KESALAHAN: {{ total_kesalahan_staff | format_number }}
                        </div>
                        {% endif %}
                    </div>
                    {# AKHIR JUDUL DAN TOTAL KESALAHAN STAFF BARU #}

                    <div class="overflow-x-auto max-h-[calc(100vh-120px)] main-content-custom">
                        <table class="data-table w-full text-sm text-left border-collapse min-w-[1000px] table-auto">
                            <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-20">
                                <tr>
                                    {% for header in staff_headers %}
                                    <th scope="col" class="px-6 py-3 whitespace-nowrap
                                        {% if loop.index == 1 %}sticky-col-header z-30{% endif %}
                                        {% if loop.index == 2 %}text-right{% endif %}"> {{ header }}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody class="staff-table-body">
                                {% for row in staff_rows %}
                                <tr class="border-b hover:bg-indigo-200 transition duration-150">
                                    {% for cell in row %}
                                    <td class="px-6 py-3 whitespace-nowrap align-top
                                        {% if loop.index == 1 %}sticky-col-cell font-semibold text-gray-900 bg-white border-r-3 border-gray-500{% endif %}
                                        {% if loop.index == 2 %}text-center font-bold text-red-600{% endif %}" >
                                        {{ cell }}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                                {# BARIS TOTAL LAMA DIHAPUS DARI SINI #}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% elif current_sheet not in SHEET_KHUSUS %}
                <p class="text-gray-500 italic flex-1 min-w-[400px] max-w-[58%] bg-white shadow-xl rounded-lg p-6">Tidak ada data staff untuk sheet ini.</p>
                {% endif %}

            </div>
        {% endif %}
    </div>
</body>
</html>