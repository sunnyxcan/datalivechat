<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kesalahan Livechat ({{ current_sheet if current_sheet else 'Live' }})</title>
    <style>
        /* SCROLLBAR STYLES */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: #3c495c;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: #68798e;
            border-radius: 10px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #8fa3b5;
        }

        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        body::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }
        body::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* GENERAL LAYOUT */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #eef2f7;
            color: #333;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background-color: #2d3748;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
            position: fixed;
            height: 100vh;
            top: 0;
            left: 0;
            overflow-y: auto;
            z-index: 100;
        }
        .sheet-nav {
            padding-bottom: 50px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
            flex-grow: 1;
        }

        /* SIDEBAR STYLES */
        .sidebar h2 {
            font-size: 1.1em;
            text-transform: uppercase;
            padding: 0 20px 10px;
            margin: 0;
            border-bottom: 1px solid #4a5568;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .sheet-nav a {
            display: block;
            padding: 12px 20px;
            text-decoration: none;
            color: #a0aec0;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
        }
        .sheet-nav a:hover {
            background-color: #4a5568;
            color: white;
        }
        .sheet-nav .active {
            background-color: #38a169;
            color: white;
            font-weight: bold;
            border-left: 5px solid #68d391;
            padding-left: 15px;
        }

        /* HEADER */
        h1 {
            color: #1a202c;
            text-align: left;
            margin-top: 0;
            padding-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        /* TABLE CONTAINER & FLEXBOX LAYOUT */
        .table-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap; 
            align-items: flex-start; /* Penting: Pastikan item mulai dari atas */
        }
        
        /* === GAYA UMUM UNTUK TABEL SUMMARY === */
        /* HANYA MENGATUR UKURAN/LEBAR */
        .table-summary, .table-summary-leader {
            flex-grow: 1;
            flex-basis: calc(50% - 10px); /* 2 kolom di baris pertama */
            min-width: 400px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border-radius: 8px;
            background-color: white;
            margin-bottom: 20px;
        }
        .table-summary-staff {
            flex-grow: 1;
            flex-basis: 100%; /* Lebar penuh */
            min-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border-radius: 8px;
            background-color: white;
            margin-bottom: 20px;
        }

        /* === GAYA KHUSUS UNTUK TAMPILAN DETAIL SHEET (KIRI-KANAN) === */
        .table-kesalahan {
            flex-basis: 40%;
            min-width: 350px; /* Biar tidak terlalu sempit */
            /* flex-grow dihapus, biarkan fleksibel berdasarkan konten tapi prioritas 40% */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            background-color: white;
        }

        .table-staff {
            flex-basis: 58%; /* Lebih besar dari 55% */
            min-width: 400px;
            /* flex-grow dihapus */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            background-color: white;
            max-height: calc(100vh - 120px); /* Tambahkan batasan tinggi di sini */
            overflow-y: auto;               /* Tambahkan scroll di sini */
        }
        /* Akhir tata letak kiri-kanan */

        /* TABLE HEADERS */
        .table-staff h2, .table-summary h2, .table-summary-staff h2, .table-summary-leader h2, .table-kesalahan h2 {
            font-size: 1.5em;
            color: #2d3748;
            margin-top: 0;
            margin-bottom: 15px;
            padding: 16px 16px 0; /* Tambahkan padding atas untuk judul */
        }

        /* GENERAL TABLE STYLES */
        .data-table {
            width: 100%;
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
            /* Hapus background dan shadow dari .table-kesalahan .data-table
               karena sudah dipindah ke wadah .table-kesalahan */
        }

        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background-color: #2d3748;
            color: white;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.05em;
            position: sticky; 
            top: 0;
            z-index: 10;
        }

        .table-staff table {
            min-width: 1000px;
            table-layout: auto;
        }
        /* Pastikan table di dalam .table-kesalahan tidak ikut di-scroll */
        .table-kesalahan table {
            table-layout: auto;
        }

        /* STICKY COLUMN FOR STAFF TABLE */
        .table-staff .data-table th:nth-child(1) {
            position: sticky; 
            left: 0;
            top: 0;
            z-index: 12; 
            border-right: 3px solid #718096; 
            background-color: #2d3748; 
        }

        .table-staff .data-table td:nth-child(1) {
            position: sticky; 
            left: 0;
            z-index: 11; 
            border-right: 3px solid #718096; 
        }

        .table-staff .data-table th:nth-child(2),
        .table-staff .data-table td:nth-child(2) {
            border-right: 3px solid #718096; 
        }

        .table-staff .data-table tbody tr:nth-child(even) td:nth-child(1) {
            background-color: #f7fafc; 
        }

        .table-staff .data-table tbody tr:nth-child(odd) td:nth-child(1) {
            background-color: white;
        }

        /* HOVER EFFECTS */
        .data-table tbody tr:hover {
            background-color: #edf2f7;
            cursor: default;
        }
        .table-staff .data-table tbody tr:hover td:nth-child(1) {
            background-color: #edf2f7;
        }

        /* SUMMARY ROW STYLES */
        .data-table tbody tr.summary-total:hover {
            background-color: #48bb78; 
            color: white; 
        }
        .data-table tbody tr.summary-total:hover td {
            background-color: #48bb78; 
        }
        .data-table tbody tr.summary-total:hover td:nth-child(1) {
            background-color: #48bb78; 
        }
        
        .summary-total {
            background-color: #38a169;
            color: white;
            font-weight: bold;
            text-align: left !important;
        }
        
        .table-staff .summary-total td:nth-child(1) {
            color: white; 
            background-color: #38a169 !important; 
        }
        
        /* Baris Pemisah antar Staff/Leader */
        .staff-change-row {
            border-top: 2px solid #a0aec0;
        }

        .summary-total td:last-child {
            text-align: right !important;
        }

        /* KESALAHAN DETAIL TABLE STYLES */
        /* Hapus background dan shadow di sini, pindah ke .table-kesalahan */
        /* .table-kesalahan .data-table {
            background-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
        } */
        .table-kesalahan td:nth-child(2) {
            max-width: 250px;
            white-space: normal;
            word-wrap: break-word;
        }
        .table-kesalahan td a {
            color: #38a169;
            text-decoration: none;
            word-wrap: break-word;
            display: inline-block;
        }
        .table-kesalahan td a:hover {
            text-decoration: underline;
        }

        .cell-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    
    {% if sheet_names %}
    <div class="sidebar">
        <h2>BUKU DOSA LIVECHAT</h2>
        <div class="sheet-nav">
            <a href="{{ url_for('show_summary') }}"
                class="{% if current_sheet == 'Summary' %}active{% endif %}">
                RINGKASAN TOTAL
            </a>
            
            {% for name in sheet_names %}
                <a href="{{ url_for('show_data', sheet_name=name) }}"
                    class="{% if name == current_sheet and current_sheet != 'Summary' %}active{% endif %}">
                    {{ name }}
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="main-content">
        <h1>Data Kesalahan Livechat: <span style="color: #38a169;">{{ current_sheet if current_sheet else 'Pilih Sheet' }}</span></h1>

        {% if current_sheet == 'Summary' %}
            <div class="table-container">
                
                <div class="table-summary" style="max-height: calc(100vh - 150px); overflow-y: auto; overflow-x: auto;">
                    <h2>Ringkasan Total Kesalahan per Situs</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 5%; text-align: center;">No.</th> 
                                <th style="width: 65%;">Nama Situs</th>
                                <th style="width: 30%; text-align: right;">Total Kesalahan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary_data %}
                            <tr>
                                <td style="text-align: center; font-weight: 500;">{{ loop.index }}</td> 
                                <td>
                                    <a href="{{ item.url }}" style="color: #2d3748; text-decoration: none; font-weight: 500;">
                                        {{ item.name }}
                                    </a>
                                </td>
                                <td style="text-align: right; font-weight: 700;">{{ item.total | format_number }}</td> 
                            </tr>
                            {% endfor %}
                            
                            {% if grand_total %}
                            <tr class="summary-total">
                                <td></td> 
                                <td>TOTAL KESELURUHAN</td>
                                <td style="text-align: right;">{{ grand_total | format_number }}</td>
                            </tr>
                            {% elif not summary_data %}
                            <tr>
                                <td colspan="3" style="text-align: center; color: #718096; padding: 20px;"> 
                                    Tidak ada data kesalahan yang ditemukan di sheet bulanan.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <div class="table-summary-leader table-summary" style="max-height: calc(100vh - 150px); overflow-y: auto; overflow-x: auto;">
                    <h2>Ringkasan Total Kesalahan per Staff</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 5%; text-align: center;">NO</th> 
                                <th style="width: 35%;">NAMA</th>
                                <th style="width: 40%;">SITUS (Total Per Situs)</th> 
                                <th style="width: 20%; text-align: right;">TOTAL KESELURUHAN</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary_staff_data %}
                                {% for item in summary_staff_data %}
                                <tr class="staff-row {% if loop.index > 1 %}staff-change-row{% endif %}">
                                    <td style="text-align: center; font-weight: 500;">{{ item.no }}</td> 
                                    <td><strong style="color: #2d3748;">{{ item.name }}</strong></td>
                                    <td>{{ item.situs_details }}</td> 
                                    <td style="text-align: right; font-weight: 700;">{{ item.grand_total_staff | format_number }}</td>
                                </tr>
                                {% endfor %}

                                <tr class="summary-total" style="border-top: 5px double white;">
                                    <td style="background-color: #38a169;"></td> 
                                    <td colspan="2" style="background-color: #38a169; text-align: right;">GRAND TOTAL KESELURUHAN</td>
                                    <td style="background-color: #38a169; text-align: right;">{{ staff_grand_total | format_number }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #718096; padding: 20px;"> 
                                        Tidak ada data ringkasan staff yang ditemukan.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="table-summary-staff" style="max-height: calc(100vh - 150px); overflow-y: auto; overflow-x: auto;">
                    <h2>Ringkasan Total Kesalahan per Leader</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 5%; text-align: center;">NO</th> 
                                <th style="width: 25%;">NAMA LEADER</th>
                                <th style="width: 50%;">NAMA SITUS (Total Per Situs)</th>
                                <th style="width: 20%; text-align: right;">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if summary_leader_data %}
                                {% for item in summary_leader_data %}
                                <tr class="leader-row {% if loop.index > 1 %}staff-change-row{% endif %}">
                                    <td style="text-align: center; font-weight: 500;">{{ item.no }}</td> 
                                    <td><strong style="color: #2d3748;">{{ item.name }}</strong></td>
                                    <td>{{ item.situs_details | safe }}</td> 
                                    <td style="text-align: right; font-weight: 700;">{{ item.total | format_number }}</td>
                                </tr>
                                {% endfor %}

                                {% if leader_grand_total %}
                                <tr class="summary-total" style="border-top: 5px double white;">
                                    <td style="background-color: #38a169;"></td> 
                                    <td colspan="2" style="background-color: #38a169; text-align: right;">GRAND TOTAL LEADER</td>
                                    <td style="background-color: #38a169; text-align: right;">{{ leader_grand_total | format_number }}</td>
                                </tr>
                                {% endif %}
                            {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center; color: #718096; padding: 20px;"> 
                                        Tidak ada data ringkasan leader yang ditemukan (periksa mapping situs).
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="table-container">

                {% if kesalahan_headers and kesalahan_data %}
                <div class="table-kesalahan">
                    <h2>Detail Kesalahan</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                {% for header in kesalahan_headers %}
                                <th {% if loop.index == 2 %}style="min-width: 150px;"{% endif %}>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in kesalahan_data %}
                            <tr>
                                {% for cell in row %}
                                <td>{{ cell | render_cell | safe }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                            {% if current_sheet in SHEET_KHUSUS %}
                            <tr class="summary-total">
                                <td colspan="{{ kesalahan_headers|length }}">Total: {{ kesalahan_data|length }} baris</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color: #718096; flex-basis: 40%;">Tidak ada data kesalahan untuk sheet ini.</p>
                {% endif %}

                {% if staff_headers and staff_rows %}
                <div class="table-staff">
                    <h2>Data Staff</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                {% for header in staff_headers %}
                                <th {% if loop.index == 2 %}style="text-align: right;"{% endif %}>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in staff_rows %}
                            <tr>
                                {% for cell in row %}
                                <td {% if loop.index == 2 %}style="text-align: right;"{% endif %}>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                            {% if total_kesalahan_staff is not none %}
                            <tr class="summary-total">
                                <td>Total</td>
                                <td style="text-align: right;">{{ total_kesalahan_staff | format_number }}</td>
                                <td colspan="{{ staff_headers|length - 2 }}"></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% elif current_sheet not in SHEET_KHUSUS %}
                <p style="color: #718096; flex-basis: 55%;">Tidak ada data staff untuk sheet ini.</p>
                {% endif %}

            </div>
        {% endif %}
    </div>
</body>
</html>