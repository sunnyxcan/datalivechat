{% extends "base.html" %}

{# Ganti judul sesuai sheet yang sedang dibuka #}
{% block title %}Kesalahan Livechat ({{ current_sheet if current_sheet else 'Pilih Sheet' }}){% endblock %}

{% block content %}

    <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Data Kesalahan Livechat: <span class="text-emerald-600">{{ current_sheet if current_sheet else 'Pilih Sheet' }}</span></h1>

    {% if current_sheet == 'Ringkasan Total' %}
    {# Bagian Ringkasan Total #}
    <div class="flex flex-wrap gap-5 mb-10 items-start">

        {# RINGKASAN SITUS #}
        <div class="table-summary w-full lg:flex-1 lg:basis-[calc(40%-10px)] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

            {# JUDUL DAN TOTAL KESALAHAN SITUS #}
            <div class="flex justify-between items-center px-6 pt-4 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Total Kesalahan per Situs</h2>
                {% if grand_total %}
                <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                    GRAND TOTAL: {{ grand_total | format_number }}
                </div>
                {% endif %}
            </div>

            <div class="overflow-y-auto max-h-[calc(100vh-200px)]">
                <table class="data-table w-full text-sm text-left border-collapse"> 
                    <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center w-[5%]">No.</th>
                            <th scope="col" class="px-6 py-3 w-[65%]">Nama Situs</th>
                            <th scope="col" class="px-6 py-3 text-right w-[30%]">Total Kesalahan</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in summary_data %}
                        <tr class="bg-white border-b hover:bg-indigo-200 transition duration-150">
                            <td class="px-6 py-3 text-center font-medium">{{ loop.index }}</td>
                            <td class="px-6 py-3">
                                <a href="{{ item.url }}" class="text-gray-800 font-medium hover:text-emerald-600 hover:underline">
                                    {{ item.name }}
                                </a>
                            </td>
                            <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.total | format_number }}</td>
                        </tr>
                        {% endfor %}

                        {% if not summary_data and not grand_total %}
                        <tr>
                            <td colspan="3" class="px-6 py-8 text-center text-gray-500 italic">
                                Tidak ada data kesalahan yang ditemukan di sheet bulanan.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        {# RINGKASAN STAFF #}
        <div class="table-summary-leader w-full lg:flex-1 lg:basis-[calc(60%-10px)] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

            {# JUDUL DAN TOTAL KESALAHAN STAFF #}
            <div class="flex justify-between items-center px-6 pt-4 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Total Kesalahan per Staff</h2>
                {% if staff_grand_total %}
                <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                    GRAND TOTAL: {{ staff_grand_total | format_number }}
                </div>
                {% endif %}
            </div>

            <div class="overflow-x-auto max-h-[calc(100vh-200px)]">
                <table class="data-table w-full text-sm text-left border-collapse">
                    <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center w-[5%]">NO</th>
                            <th scope="col" class="px-6 py-3 w-[35%]">NAMA</th>
                            <th scope="col" class="px-6 py-3 w-[40%]">SITUS (Total Per Situs)</th>
                            <th scope="col" class="px-6 py-3 text-right w-[20%]">TOTAL KESELURUHAN</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if summary_staff_data %}
                            {% for item in summary_staff_data %}
                            <tr class="staff-row border-b hover:bg-indigo-200 transition duration-150 {% if loop.index > 1 %}border-t-2 border-gray-400{% endif %}">
                                <td class="px-6 py-3 text-center font-medium">{{ item.no }}</td>
                                <td class="px-6 py-3"><strong class="text-gray-900">{{ item.name }}</strong></td>
                                <td class="px-6 py-3 text-xs text-gray-600">{{ item.situs_details }}</td>
                                <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.grand_total_staff | format_number }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">
                                    Tidak ada data ringkasan staff yang ditemukan.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        {# RINGKASAN LEADER #}
        <div class="table-summary-staff w-full bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

            {# JUDUL DAN TOTAL KESALAHAN LEADER #}
            <div class="flex justify-between items-center px-6 pt-4 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Total Kesalahan per Leader</h2>
                {% if leader_grand_total %}
                <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                    GRAND TOTAL: {{ leader_grand_total | format_number }}
                </div>
                {% endif %}
            </div>

            <div class="overflow-x-auto max-h-[calc(100vh-200px)]">
                <table class="data-table w-full text-sm text-left border-collapse">
                    <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-center w-[5%]">NO</th>
                            <th scope="col" class="px-6 py-3 w-[25%]">NAMA LEADER</th>
                            <th scope="col" class="px-6 py-3 w-[50%]">NAMA SITUS (Total Per Situs)</th>
                            <th scope="col" class="px-6 py-3 text-right w-[20%]">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if summary_leader_data %}
                            {% for item in summary_leader_data %}
                            <tr class="leader-row border-b hover:bg-indigo-200 transition duration-150 {% if loop.index > 1 %}border-t-2 border-gray-400{% endif %}">
                                <td class="px-6 py-3 text-center font-medium">{{ item.no }}</td>
                                <td class="px-6 py-3"><strong class="text-gray-900">{{ item.name }}</strong></td>
                                <td class="px-6 py-3 text-xs text-gray-600">{{ item.situs_details | safe }}</td>
                                <td class="px-6 py-3 text-right font-bold text-lg text-red-600">{{ item.total | format_number }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">
                                    Tidak ada data ringkasan leader yang ditemukan (periksa mapping situs).
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
        {# DETAIL SHEET VIEW (KESALAHAN + STAFF) #}
        <div class="flex flex-wrap gap-5 mb-10 items-start">
        
            {# DETAIL KESALAHAN #}
            {% if kesalahan_headers and kesalahan_data %}
            <div class="table-kesalahan w-full lg:flex-1 lg:max-w-[40%] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100 p-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 px-2 pt-2">Detail Kesalahan</h2>
                <div class="overflow-x-auto max-h-[calc(100vh-120px)]">
                    <table class="data-table w-full text-sm text-left border-collapse">
                        <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-10">
                            <tr>
                                {% for header in kesalahan_headers %}
                                <th scope="col" class="px-6 py-3 {% if loop.index == 2 %}min-w-[150px]{% endif %}">{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in kesalahan_data %}
                            <tr class="bg-white border-b hover:bg-indigo-200 transition duration-150">
                                {% for cell in row %}
                                <td class="px-6 py-3 align-top link-cell">
                                    <div class="cell-content max-w-[250px] break-words">
                                        {{ cell | render_cell | safe }}
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                            {% if current_sheet in SHEET_KHUSUS %}
                            <tr class="summary-total bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition duration-150">
                                <td colspan="{{ kesalahan_headers|length }}" class="px-6 py-3 text-base">Total: {{ kesalahan_data|length }} baris</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 italic flex-1 w-full lg:max-w-[40%] bg-white shadow-xl rounded-lg p-6">Tidak ada data kesalahan untuk sheet ini.</p>
            {% endif %}


            {# DETAIL STAFF #}
            {% if staff_headers and staff_rows %}
            <div class="table-staff w-full lg:flex-1 lg:max-w-[58%] bg-white shadow-xl rounded-lg overflow-hidden border border-gray-100">

                {# JUDUL DAN TOTAL KESALAHAN STAFF #}
                <div class="flex justify-between items-center px-6 pt-4 mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Data Staff</h2>
                    {% if total_kesalahan_staff is not none %}
                    <div class="text-lg font-bold text-red-600 bg-red-100 px-3 py-1 rounded-full shadow-md">
                        TOTAL KESALAHAN: {{ total_kesalahan_staff | format_number }}
                    </div>
                    {% endif %}
                </div>

                <div class="overflow-x-auto max-h-[calc(100vh-120px)] main-content-custom">
                    <table class="data-table w-full text-sm text-left border-collapse table-auto">
                        <thead class="text-xs text-white uppercase bg-gray-900 sticky top-0 z-20">
                            <tr>
                                {% for header in staff_headers %}
                                <th scope="col" class="px-6 py-3 whitespace-nowrap
                                    {% if loop.index == 1 %}
                                        {# HANYA STICKY DI LAYAR BESAR #}
                                        lg:sticky-col-header lg:z-30 
                                    {% endif %}
                                    {% if loop.index == 2 %}text-right{% endif %}"> {{ header }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="staff-table-body">
                            {% for row in staff_rows %}
                            <tr class="border-b hover:bg-indigo-200 transition duration-150">
                                {% for cell in row %}
                                <td class="px-6 py-3 whitespace-nowrap align-top
                                    {% if loop.index == 1 %}
                                        {# HANYA STICKY DI LAYAR BESAR #}
                                        lg:lg-sticky-col-cell 
                                        font-semibold text-gray-900
                                    {% endif %}
                                    {% if loop.index == 2 %}text-center font-bold text-red-600{% endif %}" >
                                    {{ cell }}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% elif current_sheet not in SHEET_KHUSUS %}
            <p class="text-gray-500 italic flex-1 w-full lg:max-w-[58%] bg-white shadow-xl rounded-lg p-6">Tidak ada data staff untuk sheet ini.</p>
            {% endif %}

        </div>
    {% endif %}

{% endblock %}